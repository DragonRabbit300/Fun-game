<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Dungeon Crawler</title>
    <style>
        :root {
            --bg: #0f1720;
            --panel: #111827;
            --accent: #f59e0b;
            --muted: #94a3b8;
        }
        body {
            margin: 0;
            padding: 20px;
            background: linear-gradient(180deg, var(--bg), #071027 120%);
            color: #e6eef8;
            font-family: system-ui, -apple-system, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #gameWrap {
            width: 900px;
            max-width: 95vw;
            margin: 24px;
        }
        canvas {
            display: block;
            width: 100%;
            height: auto;
            background: #091018;
            border-radius: 8px;
            box-shadow: 0 8px 30px rgba(2,6,23,.6);
        }
        .ui {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            gap: 12px;
            align-items: center;
        }
        .panel {
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
            padding: 8px 12px;
            border-radius: 8px;
            color: var(--muted);
            font-size: 14px;
        }
        .center {
            text-align: center;
            color: #dbeafe;
        }
        button {
            background: var(--accent);
            color: #071027;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
        }
        .small { font-size: 13px; }
        .hint { color: var(--muted); font-size: 12px; }
        .level-up {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(2,6,13,0.95);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            z-index: 100;
        }
        .level-up button {
            margin: 5px;
            padding: 10px 15px;
        }
        .loot {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(2,6,13,0.95);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="gameWrap">
        <canvas id="c" width="720" height="480"></canvas>
        <div class="ui">
            <div class="panel" id="hud">
                HP: <strong id="hp">20</strong> &nbsp; 
                XP: <strong id="xp">0</strong>/<strong id="xpMax">100</strong> &nbsp; 
                LEVEL: <strong id="level">1</strong> &nbsp; 
                SCORE: <strong id="score">0</strong>
            </div>
            <div class="panel small" id="controls">
                Move: WASD / Arrows &nbsp; Attack: Space &nbsp; Save: S
            </div>
        </div>
        <div class="center hint">
            Tip: Attack while moving to hit more enemies. Walls block movement and attacks.
        </div>
    </div>

    <script>
        // Game constants
        const TILE = 32;
        const MAP_COLS = 22;
        const MAP_ROWS = 14;
        const SAVE_KEY = 'dungeonCrawlerSave';

        // Canvas setup
        const canvas = document.getElementById('c');
        const ctx = canvas.getContext('2d');
        canvas.width = TILE * MAP_COLS;
        canvas.height = TILE * MAP_ROWS;

        // Game state
        let running = false;
        let lastTime = 0;
        let accumulator = 0;
        const TICK = 1000 / 60;

        // Player class with RPG elements
        class Player extends Entity {
            constructor(x, y) {
                super(x, y, 22, 28);
                this.level = 1;
                this.xp = 0;
                this.xpToNextLevel = 100;
                this.stats = {
                    strength: 10,
                    agility: 10,
                    intelligence: 10
                };
                this.score = 0;
                this.highScore = localStorage.getItem(SAVE_KEY) ? 
                    JSON.parse(localStorage.getItem(SAVE_KEY)).highScore : 0;
            }

            gainXP(amount) {
                this.xp += amount;
                if (this.xp >= this.xpToNextLevel) {
                    this.levelUp();
                }
            }

            levelUp() {
                this.level++;
                this.xp -= this.xpToNextLevel;
                this.xpToNextLevel = Math.floor(this.xpToNextLevel * 1.5);
                this.showLevelUpMenu();
            }

            showLevelUpMenu() {
                const menu = document.createElement('div');
                menu.className = 'level-up';
                menu.innerHTML = `
                    <h3>Level Up! (Level ${this.level})</h3>
                    <p>Choose a stat to increase:</p>
                    <button onclick="game.player.increaseStat('strength')">+Strength</button>
                    <button onclick="game.player.increaseStat('agility')">+Agility</button>
                    <button onclick="game.player.increaseStat('intelligence')">+Intelligence</button>
                `;
                document.body.appendChild(menu);
            }

            increaseStat(stat) {
                this.stats[stat]++;
                const menu = document.querySelector('.level-up');
                if (menu) menu.remove();
            }

            saveProgress() {
                const saveData = {
                    highScore: Math.max(this.score, this.highScore),
                    level: this.level,
                    xp: this.xp,
                    stats: this.stats
                };
                localStorage.setItem(SAVE_KEY, JSON.stringify(saveData));
            }
        }

        // Enemy class with loot drops
        class Enemy extends Entity {
            constructor(x, y) {
                super(x, y, 20, 24);
                this.maxHp = 8 + Math.floor(Math.random() * 6);
                this.hp = this.maxHp;
                this.lootTable = {
                    weapon: { chance: 0.3, min: 1, max: 3 },
                    armor: { chance: 0.2, min: 1, max: 2 },
                    potion: { chance: 0.4, min: 1, max: 2 }
                };
            }

            dropLoot() {
                const loot = [];
                for (const [type, data] of Object.entries(this.lootTable)) {
                    if (Math.random() < data.chance) {
                        const amount = Math.floor(Math.random() * (data.max - data.min + 1)) + data.min;
                        loot.push({ type, amount });
                    }
                }
                return loot;
            }
        }

        // Game instance
        const game = {
            player: new Player(TILE*2 + 4, TILE*2 + 4),
            enemies: [],
            items: [],
            loadSave() {
                const saveData = localStorage.getItem(SAVE_KEY);
                if (saveData) {
                    const data = JSON.parse(saveData);
                    this.player.highScore = data.highScore;
                    this.player.level = data.level;
                    this.player.xp = data.xp;
                    this.player.stats = data.stats;
                }
            },
            save() {
                this.player.saveProgress();
            }
        };

        // Input handling
        let keys = {};
        window.addEventListener('keydown', e => {
            keys[e.key.toLowerCase()] = true;
            if (e.key === ' ') e.preventDefault();
            if (e.key === 's') game.save();
        });
        window.addEventListener('keyup', e => {
            keys[e.key.toLowerCase()] = false;
        });

        // Game loop
        function loop(now) {
            const dt = Math.min(32, (now - lastTime)) / 1000;
            lastTime = now;

            if (running) {
                update(dt);
            }

            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw game
            drawMap();
            drawEntities();
            drawUI();

            requestAnimationFrame(loop);
        }

        // Start game
        game.loadSave();
        lastTime = performance.now();
        requestAnimationFrame(loop);
    </script>
</body>
</html>
